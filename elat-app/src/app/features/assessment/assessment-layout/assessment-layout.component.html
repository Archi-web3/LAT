<mat-toolbar color="primary" class="toolbar">
    <div class="toolbar-left">
        <button mat-icon-button (click)="drawer.toggle()" aria-label="Toggle menu">
            <mat-icon>menu</mat-icon>
        </button>
        <!-- Logo & Title -->
        <div class="branding">
            <span class="app-title">LAT</span>
            <span class="context-badge" *ngIf="assessmentService.context()">
                {{ assessmentService.context()?.base }}
                <span class="opacity-50">|</span>
                {{ assessmentService.context()?.evaluationMonth }}
            </span>
        </div>
    </div>

    <span class="spacer"></span>

    <!-- CENTER METRICS -->
    <div class="metrics-pill" *ngIf="assessmentService.context()">
        <div class="metric">
            <span class="label">Progress</span>
            <span class="value">{{ globalProgress() }}%</span>
        </div>
        <div class="divider"></div>
        <div class="metric">
            <span class="label">Score</span>
            <span class="value" [class.highlight]="globalScore() > 80">{{ globalScore() }}%</span>
        </div>
    </div>

    <span class="spacer"></span>

    <div class="toolbar-right">

        <!-- Offline Status -->
        <div class="status-indicator offline" *ngIf="!isOnline()" matTooltip="Offline Mode">
            <mat-icon>cloud_off</mat-icon>
        </div>

        <!-- Sync Button -->
        <button mat-icon-button *ngIf="isOnline()" (click)="manualSync()"
            [matTooltip]="assessmentService.isSyncing() ? 'Syncing...' : 'Sync Now'"
            [disabled]="assessmentService.isSyncing()">
            <mat-icon [class.spin]="assessmentService.isSyncing()">sync</mat-icon>
        </button>

        <ng-container *ngIf="assessmentService.context()">

            <!-- EXPORT MENU -->
            <button mat-icon-button [matMenuTriggerFor]="exportMenu" matTooltip="Exports">
                <mat-icon>download</mat-icon>
            </button>
            <mat-menu #exportMenu="matMenu">
                <button mat-menu-item (click)="exportPDF()">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>Export PDF Report</span>
                </button>
                <button mat-menu-item (click)="exportCSV()">
                    <mat-icon>table_view</mat-icon>
                    <span>Export CSV Data</span>
                </button>
            </mat-menu>

            <!-- ACTIONS MENU -->
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Actions">
                <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
                <button mat-menu-item routerLink="/assessment/history">
                    <mat-icon>history</mat-icon>
                    <span>View History</span>
                </button>
                <mat-divider></mat-divider>

                <button mat-menu-item (click)="submit()" *ngIf="assessmentService.status() === 'DRAFT'">
                    <mat-icon>send</mat-icon>
                    <span>Submit Assessment</span>
                </button>

                <button mat-menu-item (click)="validate()"
                    *ngIf="assessmentService.status() === 'SUBMITTED' && canValidate()">
                    <mat-icon class="green-text">check_circle</mat-icon>
                    <span>Validate</span>
                </button>

                <button mat-menu-item (click)="unlock()"
                    *ngIf="assessmentService.status() !== 'DRAFT' && canValidate()">
                    <mat-icon color="warn">lock_open</mat-icon>
                    <span>Unlock / Revert</span>
                </button>

                <button mat-menu-item (click)="resetAssessment()">
                    <mat-icon>restart_alt</mat-icon>
                    <span>Reset All Answers</span>
                </button>
            </mat-menu>

        </ng-container>

        <!-- User Profile -->
        <button mat-icon-button [matMenuTriggerFor]="userMenu">
            <mat-icon>account_circle</mat-icon>
        </button>
        <mat-menu #userMenu="matMenu">
            <div class="user-menu-header" *ngIf="authService.currentUser() as user">
                <div class="name">{{ user.name }}</div>
                <div class="role">{{ user.role }}</div>
            </div>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="setLang('EN')">ðŸ‡¬ðŸ‡§ English</button>
            <button mat-menu-item (click)="setLang('FR')">ðŸ‡«ðŸ‡· FranÃ§ais</button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="logout()">
                <mat-icon>logout</mat-icon>
                <span>Logout</span>
            </button>
        </mat-menu>
    </div>
</mat-toolbar>

<mat-sidenav-container class="sidenav-container">
    <mat-sidenav #drawer [mode]="isMobile() ? 'over' : 'side'" [opened]="!isMobile()" class="sidenav">
        <mat-nav-list (click)="closeOnMobile()">

            <!-- Collapsible Header -->
            <div mat-subheader class="sidebar-header" (click)="showDashboards.set(!showDashboards())">
                <span>Dashboards & Vues</span>
                <mat-icon class="toggle-icon">{{ showDashboards() ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>

            <!-- Collapsible Content -->
            @if (showDashboards()) {
            <div class="collapsible-menu">
                <a mat-list-item routerLink="/assessment/list" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>history</mat-icon>
                    <span matListItemTitle>{{ 'MENU.MY_ASSESSMENTS' | translate }}</span>
                </a>
                <a mat-list-item routerLink="/matrix" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>dashboard</mat-icon>
                    <span matListItemTitle>{{ 'MENU.MATRIX_DASHBOARD' | translate }}</span>
                </a>
                <a mat-list-item routerLink="/action-plan" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>event_note</mat-icon>
                    <span matListItemTitle>{{ 'MENU.ACTION_PLAN' | translate }}</span>
                </a>

                @if (['SUPER_ADMIN', 'POOL_COORDINATOR', 'COUNTRY_COORDINATOR'].includes(authService.currentUser()?.role
                || '')) {
                <a mat-list-item routerLink="/coordination" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>public</mat-icon>
                    <span matListItemTitle>{{ 'MENU.COORDINATION' | translate }}</span>
                </a>
                }

                @if (authService.currentUser()?.role === 'SUPER_ADMIN') {
                <a mat-list-item routerLink="/assessment/admin/users" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>people</mat-icon>
                    <span matListItemTitle>{{ 'MENU.USERS' | translate }}</span>
                </a>
                <a mat-list-item routerLink="/assessment/admin/config" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>settings</mat-icon>
                    <span matListItemTitle>{{ 'MENU.CONFIG' | translate }}</span>
                </a>
                <a mat-list-item routerLink="/assessment/admin/roadmap" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>map</mat-icon>
                    <span matListItemTitle>Roadmap</span>
                </a>
                <a mat-list-item routerLink="/admin/docs" routerLinkActive="active-link">
                    <mat-icon matListItemIcon>menu_book</mat-icon>
                    <span matListItemTitle>Admin Guide</span>
                </a>
                }
            </div>
            }

            <h3 matSubheader>Sections ({{ sections().length }})</h3>
            @for (section of sections(); track section.id) {
            <a mat-list-item [routerLink]="['/assessment', section.id]" routerLinkActive="active-link"
                class="section-item" [style.border-left-color]="getCategoryColor(section.title)">
                <span matListItemTitle class="section-title">{{ section | localize:'title' }}</span>
                <div matListItemLine class="section-meta">
                    <span>{{ section.questions.length }} Q</span>
                    <span class="section-progress" [class.complete]="getSectionProgress(section.id) === 100">
                        {{ getSectionProgress(section.id) }}%
                    </span>
                </div>
            </a>
            }


        </mat-nav-list>
    </mat-sidenav>
    <mat-sidenav-content class="content">
        <router-outlet></router-outlet>
    </mat-sidenav-content>
</mat-sidenav-container>